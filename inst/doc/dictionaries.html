<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Dictionaries</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Dictionaries</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(zstdlite)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(bench)</span></code></pre></div>
<div id="dictionary-based-compression" class="section level2">
<h2>Dictionary-based compression</h2>
<p>Using a dictionary can be beneficial when compressing lots of small
objects with similar structure or content.</p>
<p>Instead of the compressor starting from scratch for every new object,
a <em>dictionary</em> can be trained and used such that there is some
starting information common to all objects - it’s like giving the
compressor a bit of a head-start.</p>
<p>The following notes presented below are from <code>zstd</code>
dictionary documentation:</p>
<div id="why-should-i-use-a-dictionary" class="section level4">
<h4>Why should I use a dictionary?</h4>
<p>Zstd can use dictionaries to improve compression ratio of small data.
Traditionally small files don’t compress well because there is very
little repetition in a single sample, since it is small. But, if you are
compressing many similar files, like a bunch of JSON records that share
the same structure, you can train a dictionary on ahead of time on some
samples of these files. Then, zstd can use the dictionary to find
repetitions that are present across samples. This can vastly improve
compression ratio.</p>
</div>
<div id="when-is-a-dictionary-useful" class="section level4">
<h4>When is a dictionary useful?</h4>
<p>Dictionaries are useful when compressing many small files that are
similar. The larger a file is, the less benefit a dictionary will have.
Generally, we don’t expect dictionary compression to be effective past
100KB. And the smaller a file is, the more we would expect the
dictionary to help.</p>
</div>
<div id="how-do-i-train-a-dictionary" class="section level4">
<h4>How do I train a dictionary?</h4>
<p>Gather samples from your use case. These samples should be similar to
each other. If you have several use cases, you could try to train one
dictionary per use case. If the dictionary training function fails, that
is likely because you either passed too few samples, or a dictionary
would not be effective for your data.</p>
</div>
<div id="how-large-should-my-dictionary-be" class="section level4">
<h4>How large should my dictionary be?</h4>
<p>A reasonable dictionary size, the <code>dictBufferCapacity</code>, is
about 100KB. The zstd CLI defaults to a 110KB dictionary. You likely
don’t need a dictionary larger than that. But, most use cases can get
away with a smaller dictionary. The advanced dictionary builders can
automatically shrink the dictionary for you, and select the smallest
size that doesn’t hurt compression ratio too much. See the
<code>shrinkDict</code> parameter. A smaller dictionary can save memory,
and potentially speed up compression.</p>
</div>
<div id="how-many-samples-should-i-provide-to-the-dictionary-builder" class="section level4">
<h4>How many samples should I provide to the dictionary builder?</h4>
<p>We generally recommend passing ~100x the size of the dictionary in
samples. A few thousand should suffice. Having too few samples can hurt
the dictionaries effectiveness. Having more samples will only improve
the dictionaries effectiveness. But having too many samples can slow
down the dictionary builder.</p>
</div>
<div id="how-do-i-determine-if-a-dictionary-will-be-effective" class="section level4">
<h4>How do I determine if a dictionary will be effective?</h4>
<p>Simply train a dictionary and try it out.</p>
</div>
<div id="when-should-i-retrain-a-dictionary" class="section level4">
<h4>When should I retrain a dictionary?</h4>
<p>You should retrain a dictionary when its effectiveness drops.
Dictionary effectiveness drops as the data you are compressing changes.
Generally, we do expect dictionaries to “decay” over time, as your data
changes, but the rate at which they decay depends on your use case.
Internally, we regularly retrain dictionaries, and if the new dictionary
performs significantly better than the old dictionary, we will ship the
new dictionary.</p>
</div>
</div>
<div id="example" class="section level2">
<h2>Example</h2>
<p>The following shows that using a dictionary for this specific example
gives ~35% smaller files in ~75% of the time.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>countries <span class="ot">&lt;-</span> <span class="fu">rownames</span>(LifeCycleSavings)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co"># Create &#39;test&#39; and &#39;train&#39; datasets</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co"># In this example consider the case of having a named vector of rankings of </span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># countries.  Each ranking will be compressed separately and stored (say in a database)</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>train_samples <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, </span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>  \(x) <span class="fu">setNames</span>(<span class="fu">sample</span>(<span class="fu">length</span>(countries)), countries)</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>)</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>test_samples <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, </span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  \(x) <span class="fu">setNames</span>(<span class="fu">sample</span>(<span class="fu">length</span>(countries)), countries)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>)</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="co"># Create a dictionary</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>dict <span class="ot">&lt;-</span> <span class="fu">zstd_train_dict_serialize</span>(train_samples, <span class="at">size =</span> <span class="dv">5000</span>, <span class="at">optim =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a><span class="co"># Setup Compression/Decompression contexts to use this dictionary</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>cctx_nodict <span class="ot">&lt;-</span> <span class="fu">zstd_cctx</span>(<span class="at">level =</span> <span class="dv">3</span>) <span class="co"># No dictionary. For comparison</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>cctx_dict   <span class="ot">&lt;-</span> <span class="fu">zstd_cctx</span>(<span class="at">level =</span> <span class="dv">3</span>, <span class="at">dict =</span> dict)</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a><span class="co"># When using the dictionary, what is the size of the compressed data compared</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a><span class="co"># to not using a dicionary here?</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>s1 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(test_samples, \(x) <span class="fu">zstd_serialize</span>(x, <span class="at">cctx =</span> cctx_nodict)) <span class="sc">|&gt;</span> <span class="fu">lengths</span>() <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(test_samples, \(x) <span class="fu">zstd_serialize</span>(x, <span class="at">cctx =</span> cctx_dict  )) <span class="sc">|&gt;</span> <span class="fu">lengths</span>() <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">round</span>(s2<span class="sc">/</span>s1 <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">&quot;%&quot;</span>)</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a><span class="co">#&gt; 63.1 %</span></span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a><span class="co"># Simple benchmark to test speed when using dicionary.</span></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>  <span class="st">&quot;No Dict&quot;</span> <span class="ot">=</span> <span class="fu">lapply</span>(test_samples, \(x) <span class="fu">zstd_serialize</span>(x, <span class="at">cctx =</span> cctx_nodict)),</span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>  <span class="st">&quot;Dict&quot;</span>    <span class="ot">=</span> <span class="fu">lapply</span>(test_samples, \(x) <span class="fu">zstd_serialize</span>(x, <span class="at">cctx =</span> cctx_dict  )),</span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>  <span class="at">check =</span> <span class="cn">FALSE</span></span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a>)[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a><span class="co">#&gt; 1 No Dict     10.77ms   11.3ms      87.8      18MB</span></span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a><span class="co">#&gt; 2 Dict         7.67ms    8.1ms     123.       18MB</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
